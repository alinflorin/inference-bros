<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoicing Admin</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@emotion/react@11/dist/emotion-react.umd.min.js"></script>
    <script src="https://unpkg.com/@emotion/styled@11/dist/emotion-styled.umd.min.js"></script>
    <script src="https://unpkg.com/@mui/material@5.15.0/umd/material-ui.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body, #root {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f4f7f9;
        }
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
        }
        .tab-panel {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 16px;
        }
        .json-display {
            background: #1e1e1e;
            color: #75beff;
            padding: 16px;
            border-radius: 8px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            flex-grow: 1;
            border: 1px solid #333;
            margin: 0;
        }
        .table-wrapper {
            flex-grow: 1;
            overflow: auto;
            border-radius: 8px;
            background: white;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const {
            Container, Typography, Box, Paper, Button, TextField,
            Grid, CircularProgress, Tabs, Tab,
            Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
            Select, MenuItem, FormControl, InputLabel, Chip, Stack,
            IconButton, Collapse
        } = MaterialUI;

        function CollapsibleInvoiceRow({ row }) {
            const [open, setOpen] = React.useState(false);
            const invoice = row.invoice;
            return (
                <React.Fragment>
                    <TableRow hover>
                        <TableCell width="40">
                            <IconButton size="small" onClick={() => setOpen(!open)}>{open ? <>&#9650;</> : <>&#9660;</>}</IconButton>
                        </TableCell>
                        <TableCell sx={{ fontWeight: 'bold' }}>{invoice.customer_name}</TableCell>
                        <TableCell>EUR {invoice.total_cost.toFixed(2)}</TableCell>
                        <TableCell>{invoice.total_tokens.toLocaleString()}</TableCell>
                        <TableCell>
                            <Chip label={row.sync_result.status} size="small" color={row.sync_result.status === "success" ? "success" : "default"} />
                        </TableCell>
                        <TableCell sx={{ fontSize: "10px", color: "#888" }}>{row.sync_result.odoo_id || row.sync_result.error || "-"}</TableCell>
                    </TableRow>
                    <TableRow>
                        <TableCell style={{ paddingBottom: 0, paddingTop: 0 }} colSpan={6}>
                            <Collapse in={open} timeout="auto" unmountOnExit>
                                <Box sx={{ margin: 2, borderLeft: '4px solid #1976d2', pl: 2, pb: 2 }}>
                                    <Typography variant="subtitle2" gutterBottom component="div">Usage Details</Typography>
                                    <Table size="small">
                                        <TableHead>
                                            <TableRow>
                                                <TableCell>Model</TableCell>
                                                <TableCell align="right">Requests</TableCell>
                                                <TableCell align="right">Tokens</TableCell>
                                                <TableCell align="right">Cost</TableCell>
                                            </TableRow>
                                        </TableHead>
                                        <TableBody>
                                            {Object.values(invoice.models || {}).map((m) => (
                                                <TableRow key={m.model_name}>
                                                    <TableCell>{m.model_name}</TableCell>
                                                    <TableCell align="right">{m.total_requests.toLocaleString()}</TableCell>
                                                    <TableCell align="right">{m.total_tokens.toLocaleString()}</TableCell>
                                                    <TableCell align="right">{m.cost.toFixed(4)}</TableCell>
                                                </TableRow>
                                            ))}
                                        </TableBody>
                                    </Table>
                                </Box>
                            </Collapse>
                        </TableCell>
                    </TableRow>
                </React.Fragment>
            );
        }

        function App() {
            const [activeTab, setActiveTab] = React.useState(0);
            const [loading, setLoading] = React.useState(false);
            const [billingDate, setBillingDate] = React.useState("");
            const [syncMode, setSyncMode] = React.useState("none");
            const [statsKey, setStatsKey] = React.useState("");
            const [startDate, setStartDate] = React.useState("");
            const [endDate, setEndDate] = React.useState("");
            const [invResults, setInvResults] = React.useState(null);
            const [pricingRes, setPricingRes] = React.useState(null);
            const [usageRes, setUsageRes] = React.useState(null);
            const [modelsRes, setModelsRes] = React.useState(null);

            const apiCall = async (endpoint, setter, options = {}) => {
                setLoading(true);
                try {
                    const response = await fetch(endpoint, options);
                    const data = await response.json();
                    setter(data);
                } catch (err) {
                    console.error("API Error:", err);
                    setter({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                if (activeTab === 1 && !pricingRes) apiCall("/bifrost/pricingSheet", setPricingRes);
                if (activeTab === 3 && !modelsRes) apiCall("/openrouter/models", setModelsRes);
            }, [activeTab]);

            const triggerInvoicing = () => {
                let path = "/invoicing/generate?dry_run=" + syncMode;
                if (billingDate) path += "&date=" + billingDate;
                apiCall(path, setInvResults);
            };

            const fetchUsage = () => {
                if (!statsKey || !startDate || !endDate) { alert("Key and dates required"); return; }
                const startISO = new Date(startDate + 'T00:00:00Z').toISOString();
                const endISO = new Date(endDate + 'T23:59:59Z').toISOString();
                const params = new URLSearchParams({ start_date: startISO, end_date: endISO });
                apiCall(`/usage?${params}`, setUsageRes, {
                    headers: { 'Authorization': `Bearer ${statsKey}` }
                });
            };

            return (
                <div className="app-container">
                    <Paper elevation={1} sx={{ borderRadius: 2 }}>
                        <Tabs value={activeTab} onChange={(e, v) => setActiveTab(v)} variant="fullWidth">
                            <Tab label="Run Invoicing" />
                            <Tab label="Pricing Sheet" />
                            <Tab label="Usage Stats" />
                            <Tab label="Cluster Models" />
                        </Tabs>
                    </Paper>

                    <Box className="tab-panel">
                        {activeTab === 0 && (
                            <Grid container spacing={2} sx={{ height: "100%" }}>
                                <Grid item xs={12} md={3}>
                                    <Stack spacing={2}>
                                        <TextField label="Simulation Date" type="date" value={billingDate} onChange={e => setBillingDate(e.target.value)} InputLabelProps={{ shrink: true }} fullWidth />
                                        <FormControl fullWidth>
                                            <InputLabel>Sync Type</InputLabel>
                                            <Select value={syncMode} label="Sync Type" onChange={e => setSyncMode(e.target.value)}>
                                                <MenuItem value="none">Live (Odoo Sync)</MenuItem>
                                                <MenuItem value="validate">Validate Only</MenuItem>
                                                <MenuItem value="all">Full Dry Run</MenuItem>
                                            </Select>
                                        </FormControl>
                                        <Button variant="contained" onClick={triggerInvoicing} disabled={loading} size="large" disableElevation>
                                            {loading ? <CircularProgress size={24} color="inherit" /> : "Generate Invoices"}
                                        </Button>
                                    </Stack>
                                </Grid>
                                <Grid item xs={12} md={9} sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                                    <div className="table-wrapper">
                                        {invResults ? (
                                            <Table size="small" stickyHeader>
                                                <TableHead>
                                                    <TableRow>
                                                        <TableCell width="40" />
                                                        <TableCell>Customer</TableCell>
                                                        <TableCell>Cost</TableCell>
                                                        <TableCell>Tokens</TableCell>
                                                        <TableCell>Status</TableCell>
                                                        <TableCell>Reference</TableCell>
                                                    </TableRow>
                                                </TableHead>
                                                <TableBody>
                                                    {invResults.details?.map((row, i) => (
                                                        <CollapsibleInvoiceRow key={i} row={row} />
                                                    ))}
                                                </TableBody>
                                            </Table>
                                        ) : (
                                            <Box sx={{ p: 4, textAlign: "center", color: "#aaa" }}>Run invoicing to see results.</Box>
                                        )}
                                    </div>
                                </Grid>
                            </Grid>
                        )}

                        {activeTab === 1 && (
                            <Stack spacing={2} sx={{ height: "100%" }}>
                                <Box><Button size="small" variant="outlined" onClick={() => apiCall("/bifrost/pricingSheet", setPricingRes)}>Refresh</Button></Box>
                                <pre className="json-display">{pricingRes ? JSON.stringify(pricingRes, null, 2) : "// Loading pricing data..."}</pre>
                            </Stack>
                        )}

                        {activeTab === 2 && (
                            <Grid container spacing={2} sx={{ height: "100%" }}>
                                <Grid item xs={12} md={3}>
                                    <Stack spacing={2}>
                                        <TextField label="API Key" value={statsKey} onChange={e => setStatsKey(e.target.value)} fullWidth type="password" />
                                        <TextField label="Start Date" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} InputLabelProps={{ shrink: true }} fullWidth />
                                        <TextField label="End Date" type="date" value={endDate} onChange={e => setEndDate(e.target.value)} InputLabelProps={{ shrink: true }} fullWidth />
                                        <Button variant="contained" onClick={fetchUsage} disabled={loading} size="large" disableElevation>
                                            {loading ? <CircularProgress size={24} color="inherit" /> : "Fetch Usage Stats"}
                                        </Button>
                                    </Stack>
                                </Grid>
                                <Grid item xs={12} md={9} sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                                    <pre className="json-display">{usageRes ? JSON.stringify(usageRes, null, 2) : "// Enter API key and date range, then click fetch"}</pre>
                                </Grid>
                            </Grid>
                        )}

                        {activeTab === 3 && (
                            <Stack spacing={2} sx={{ height: "100%" }}>
                                <Box><Button size="small" variant="outlined" onClick={() => apiCall("/openrouter/models", setModelsRes)}>Refresh</Button></Box>
                                <pre className="json-display">{modelsRes ? JSON.stringify(modelsRes, null, 2) : "// Loading model data..."}</pre>
                            </Stack>
                        )}
                    </Box>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
